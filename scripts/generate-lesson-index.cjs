/* eslint-env node */
/* eslint-disable @typescript-eslint/no-require-imports */

const fs = require("fs");
const path = require("path");

const lessonsDir = path.join(__dirname, "..", "src", "content", "lessons");
const outputPath = path.join(lessonsDir, "index.ts");

const header = `// Auto-generated by scripts/generate-lesson-index.cjs
// Do not edit manually.
import type { LessonMeta, LessonModule } from "@/features/lessons/model/types";

export const lessonLoaders: Record<string, () => Promise<LessonModule>> = {
`;

function build() {
  let files = [];
  try {
    files = fs.readdirSync(lessonsDir);
  } catch {
    fs.mkdirSync(lessonsDir, { recursive: true });
  }

  const mdxFiles = files.filter((file) => file.endsWith(".mdx"));

  const lessons = mdxFiles.map((file) => {
    const slug = file.replace(/\.mdx$/, "");
    const source = fs.readFileSync(path.join(lessonsDir, file), "utf8");
    const meta = extractMeta(source, slug);
    return { file, slug, meta };
  });

  const entries = lessons.map(({ file, slug }) => `  "${slug}": () => import("./${file}"),`).join("\n");

  const metaEntries = lessons
    .map(({ slug, meta }) => {
      const safeMeta = meta ?? { slug, title: slug, description: "", order: 0 };
      return `  "${slug}": ${JSON.stringify({ ...safeMeta, slug })},`;
    })
    .join("\n");

  const footer = `};\n\nexport const lessonMeta: Record<string, LessonMeta> = {\n${metaEntries}\n};\n\nexport const lessonSlugs = Object.keys(lessonLoaders);\n`;

  const content = `${header}${entries}\n${footer}`;
  fs.writeFileSync(outputPath, content);
}

function extractMeta(source, slug) {
  const match = source.match(/export\s+const\s+meta\s*=\s*({[\s\S]*?})\s*;/);
  if (!match) return null;

  try {
    const meta = new Function(`return (${match[1]});`)();
    if (!meta || typeof meta !== "object") return null;
    return {
      ...meta,
      slug: typeof meta.slug === "string" && meta.slug.trim() ? meta.slug : slug,
    };
  } catch (error) {
    console.warn(`Unable to parse meta for lesson "${slug}":`, error);
    return null;
  }
}

build();
